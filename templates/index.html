<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Pools Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: url('https://i.pinimg.com/originals/7b/f1/63/7bf16325996924c538a0f9689622d14f.jpg');
            background-size: 150px;
            background-color: #000;
            color: white;
            font-family: 'sans-serif';
        }
        .glass {
            background: rgba(26, 26, 26, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="glass w-full max-w-md p-8 rounded-2xl shadow-2xl">
        <h1 class="text-2xl font-bold text-center text-cyan-400 mb-6 uppercase tracking-widest">Analisis Pools</h1>

        {% if not logged_in %}
        <div id="login-box" class="space-y-4">
            <p class="text-sm text-gray-400 text-center">Masukkan Lisensi Key untuk Mengakses Tool</p>
            <input type="text" id="access-key" class="w-full bg-black/50 border border-cyan-900 p-3 rounded-lg text-center text-cyan-300 outline-none" placeholder="XXXX-XXXX-XXXX">
            <button onclick="handleLogin()" class="w-full bg-cyan-600 hover:bg-cyan-500 p-3 rounded-lg font-bold transition">AKTIFKAN AKSES</button>
            <p class="text-xs text-center text-gray-500">Hubungi Admin untuk pembelian key</p>
        </div>
        {% else %}
        <div id="main-feature" class="space-y-6">
            <select id="market" class="w-full bg-gray-800 p-3 rounded-lg border border-cyan-600 outline-none">
                {% for m in markets %}
                <option value="{{ m }}">{{ m }}</option>
                {% endfor %}
            </select>
            <button onclick="startAnalyze()" id="btn-text" class="w-full bg-gradient-to-r from-cyan-600 to-blue-700 p-3 rounded-lg font-bold">MULAI ANALISIS</button>
            
            <div id="result" class="hidden space-y-3 pt-4 border-t border-gray-700">
                <div class="flex justify-between bg-black/30 p-3 rounded border border-white/5">
                    <span>Result Terakhir:</span> <b id="res-last" class="text-cyan-400">0000</b>
                </div>
                <div class="bg-black/40 p-4 rounded-xl text-center border-2 border-cyan-500">
                    <span class="text-xs text-gray-400 uppercase">Angka Main BBFS</span>
                    <h2 id="res-bbfs" class="text-4xl font-black tracking-tighter text-white">------</h2>
                    <button onclick="copyBBFS()" class="mt-2 text-xs bg-gray-700 px-2 py-1 rounded">Salin</button>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="bg-black/30 p-3 rounded">Jitu 2D: <br><b id="res-jitu">--</b></div>
                    <div class="bg-black/30 p-3 rounded">Shadow: <br><b id="res-shadow">--</b></div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        async function handleLogin() {
    const keyInput = document.getElementById('access-key');
    const key = keyInput.value.trim();
    
    if (!key) {
        alert("Silakan isi key terlebih dahulu!");
        return;
    }

    try {
        // Gunakan FormData agar Flask request.form.get('key') bisa membaca dengan benar
        const formData = new FormData();
        formData.append('key', key);

        const resp = await fetch('/login', {
            method: 'POST',
            body: formData // Kirim sebagai form data
        });

        const data = await resp.json();

        if (resp.ok && data.status === 'success') {
            alert("Lisensi Berhasil Diaktifkan!");
            window.location.reload(); // Paksa reload untuk memperbarui session
        } else {
            alert(data.message || "Key salah atau tidak valid");
        }
    } catch (error) {
        console.error("Error:", error);
        alert("Terjadi kesalahan koneksi ke server.");
    }
}

        async function startAnalyze() {
            const market = document.getElementById('market').value;
            const btn = document.getElementById('btn-text');
            btn.innerText = "SEDANG MENGHITUNG...";
            
            try {
                const resp = await fetch('/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `market=${market}`
                });
                const data = await resp.json();
                
                document.getElementById('result').classList.remove('hidden');
                document.getElementById('res-last').innerText = data.last;
                document.getElementById('res-bbfs').innerText = data.bbfs;
                document.getElementById('res-jitu').innerText = data.jitu;
                document.getElementById('res-shadow').innerText = data.shadow;
            } catch (e) {
                alert("Koneksi Error / Sesi Habis");
            }
            btn.innerText = "MULAI ANALISIS";
        }

        function copyBBFS() {
            const bbfs = document.getElementById('res-bbfs').innerText;
            navigator.clipboard.writeText(bbfs);
            alert("BBFS disalin!");
        }
    </script>
</body>
</html>
